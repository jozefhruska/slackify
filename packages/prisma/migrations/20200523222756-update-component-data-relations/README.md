# Migration `20200523222756-update-component-data-relations`

This migration has been generated by Jozef Hru≈°ka at 5/23/2020, 10:27:56 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX "public"."Component_articleDataId"

DROP INDEX "public"."Component_linkDataId"

DROP INDEX "public"."Component_plainTextDataId"

ALTER TABLE "public"."ArticleComponentData" ADD COLUMN "componentId" text   ;

ALTER TABLE "public"."Component" DROP CONSTRAINT IF EXiSTS "Component_articleDataId_fkey",
DROP CONSTRAINT IF EXiSTS "DeleteLinkComponentData",
DROP CONSTRAINT IF EXiSTS "Component_linkDataId_fkey",
DROP CONSTRAINT IF EXiSTS "Component_plainTextDataId_fkey",
DROP COLUMN "articleDataId",
DROP COLUMN "linkDataId";

ALTER TABLE "public"."LinkComponentData" ADD COLUMN "componentId" text   ;

ALTER TABLE "public"."PlainTextComponentData" ADD COLUMN "componentId" text   ;

ALTER TABLE "public"."StatRecord" DROP CONSTRAINT IF EXiSTS "OnComponentDelete";

CREATE UNIQUE INDEX "ArticleComponentData_componentId" ON "public"."ArticleComponentData"("componentId")

CREATE UNIQUE INDEX "LinkComponentData_componentId" ON "public"."LinkComponentData"("componentId")

CREATE UNIQUE INDEX "PlainTextComponentData_componentId" ON "public"."PlainTextComponentData"("componentId")

ALTER TABLE "public"."ArticleComponentData" ADD FOREIGN KEY ("componentId")REFERENCES "public"."Component"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."LinkComponentData" ADD FOREIGN KEY ("componentId")REFERENCES "public"."Component"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."PlainTextComponentData" ADD FOREIGN KEY ("componentId")REFERENCES "public"."Component"("id") ON DELETE SET NULL  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200523222310-edit-component-data-relation..20200523222756-update-component-data-relations
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("DATABASE_URL")
   enabled  = env("DATABASE_URL")
 }
 generator cient_common {
@@ -55,16 +55,14 @@
   authorId        String
   team            Team                    @relation(fields: [teamId], references: [id])
   teamId          String
   plainTextDataId String?
-  plainTextData   PlainTextComponentData? @relation(fields: [plainTextDataId], references: [id])
-  articleDataId   String?
-  articleData     ArticleComponentData?   @relation(fields: [articleDataId], references: [id])
-  linkDataId      String?
-  linkData        LinkComponentData?      @relation(fields: [linkDataId], references: [id])
+  plainTextData   PlainTextComponentData?
+  articleData     ArticleComponentData?
+  linkData        LinkComponentData?
   createdAt       DateTime                @default(now())
   updatedAt       DateTime                @updatedAt
-  StatRecord      StatRecord[]
+  statRecord      StatRecord[]
 }
 model StatRecord {
   id          String     @default(cuid()) @id
@@ -75,26 +73,29 @@
   @@unique([createdAt, componentId])
 }
 model PlainTextComponentData {
-  id        String    @default(cuid()) @id
-  text      String
-  Component Component
+  id          String     @default(cuid()) @id
+  text        String
+  componentId String?
+  component   Component? @relation(fields: [componentId], references: [id])
 }
 model ArticleComponentData {
-  id        String    @default(cuid()) @id
-  title     String
-  lead      String?
-  content   String
-  Component Component
+  id          String     @default(cuid()) @id
+  title       String
+  lead        String?
+  content     String
+  componentId String?
+  component   Component? @relation(fields: [componentId], references: [id])
 }
 model LinkComponentData {
-  id        String    @default(cuid()) @id
-  text      String?
-  url       String
-  Component Component
+  id          String     @default(cuid()) @id
+  text        String?
+  url         String
+  componentId String?
+  component   Component? @relation(fields: [componentId], references: [id])
 }
 enum UserRole {
   OWNER
```


